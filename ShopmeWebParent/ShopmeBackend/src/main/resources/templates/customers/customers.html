<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments :: page_head('Customers - Shopme Admin')}"></head>
<body>
<div class="container-fluid">
    <div th:replace="~{fragments :: top_navbar}"></div>

    <div>
        <h2>Manage Customers</h2>

        <a class="fa-solid fa-file-csv fa-2x text-decoration-none link-secondary me-2"
           th:href="@{/customers/export/csv}"></a>
    </div>

    <div th:replace="~{fragments :: message_and_search_form()}"></div>

    <div class="full-details">
        <table class="table table-bordered table-striped table-hover table-responsive-xl">
            <thead class="table-dark">
            <tr>
                <th>
                    <th th:replace="~{fragments::column_link(sortFieldName = 'id',
                        columnLabel = 'ID', removeTag = 'tag')}">ID</th>
                </th>
                <th th:replace="~{fragments::column_link(sortFieldName = 'firstName',
                    columnLabel = 'First Name', removeTag ='none')}"></th>
                <th th:replace="~{fragments::column_link(sortFieldName = 'lastName',
                    columnLabel = 'Last Name', removeTag ='none')}"></th>
                <th class="hideable-column">
                    <th th:replace="~{fragments::column_link(sortFieldName = 'email',
                        columnLabel = 'E-mail', removeTag ='tag')}"></th>
                </th>
                <th class="hideable-column">
                    <th th:replace="~{fragments::column_link(sortFieldName = 'city',
                        columnLabel = 'City', removeTag ='tag')}"></th>
                </th>
                <th class="hideable-column">
                    <th th:replace="~{fragments::column_link(sortFieldName = 'state',
                        columnLabel = 'State', removeTag ='tag')}"></th>
                </th>
                <th>
                    <th th:replace="~{fragments::column_link(sortFieldName = 'country.name',
                        columnLabel = 'Country', removeTag ='tag')}"></th>
                </th>
                <th th:replace="~{fragments::column_link(sortFieldName = 'enabled',
                    columnLabel = 'Enabled',removeTag ='none')}"></th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="customer, iterStat : ${listCustomers}">
                <td>[[${customer.id}]]</td> <!-- <td>[[${iterStat.count}]]</td> <!==iterStat.index is zero-based ==>-->
                <td>[[${customer.firstName}]]</td>
                <td>[[${customer.lastName}]]</td>
                <td class="hideable-column">[[${customer.email}]]</td>
                <td class="hideable-column">[[${customer.city}]]</td>
                <td class="hideable-column">[[${customer.state}]]</td>
                <td>[[${customer.country.name}]]</td>
                <td>
                    <th:block th:replace="~{fragments :: status(${customer.id}, ${customer.enabled}, 'customer')}"></th:block>
                </td>
                <td>
                    <a class="fa-solid fa-file-alt fa-2x text-decoration-none link-success link-detail"
                       th:href="@{'/customers/details/' + ${customer.id}}"
                       title="View details of this customer"></a>
                    &nbsp;
                    <th:block th:replace="~{fragments :: edit_entity(${customer.id}, 'customer')}"></th:block>
                    &nbsp;
                    <th:block th:replace="~{fragments :: delete_entity(${customer.id}, 'customer', true)}"></th:block>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="less-details">
        <div class="row my-1" th:each="customer : ${listCustomers}">
            <div class="col-4">
                <span class="fw-bold">
                    [[${customer.fullName}]]
                </span>
            </div>

            <div class="col-8">
                <div>
                    <span >[[${customer.country.name}]]</span>
                </div>
                <div class="mt-2">
                    <th:block th:replace="~{fragments :: status(${customer.id}, ${customer.enabled}, 'customer')}"></th:block>
                    &nbsp;
                    <a class="fa-solid fa-file-alt fa-2x text-decoration-none link-success link-detail"
                       th:href="@{'/customers/details/' + ${customer.id}}"
                       title="View details of this customer"></a>
                    &nbsp;
                    <th:block th:replace="~{fragments :: edit_entity(${customer.id}, 'customer')}"></th:block>
                    &nbsp;
                    <th:block th:replace="~{fragments :: delete_entity(${customer.id}, 'customer', true)}"></th:block>
                </div>
            </div>

            <div>&nbsp;</div>

        </div>
    </div>

    <!-- Details Modal -->
    <div class="modal fade" id="customerDetailsModal">
        <div class="modal-dialog">
            <div class="modal-content" id="customerDetailsModalContent">
            </div>
        </div>
    </div>

    <div th:replace="~{fragments :: delete_dialogue}"></div>

    <div th:replace="~{fragments :: pagination()}"></div>

    <div th:replace="~{fragments :: footer}"></div>
</div>
<script>
    let entity = 'customer', path = "[[@{/customers}]]";

    $(document).ready(function () {
        $(".link-detail").click(function (event) {
            event.preventDefault();
            const url = $(this).attr('href');
            getCustomer(url);
        });

    });

    function getCustomer(url) {
        const modalElement = $("#customerDetailsModal");
        const modalInstance = new bootstrap.Modal(modalElement);

        // Fetches url (like $.get(url)) and inserts its contents inside .modal-content
        // Select using the id, not the class, as the class is used for multiple modals such as delete_dialogue
        $("#customerDetailsModalContent").load(url, function () {
            modalInstance.show(); // Show after content is loaded
        });

        // Focus on the element that was clicked to open the modal, to return focus to it when the modal is closed.
        // This is to prevent the modal from stealing focus from the element that was clicked to open it and avoid
        // the warning "Blocked aria-hidden on an element because its descendant retained focus" in the console.
        let lastFocusedElement;
        modalElement.on('show.bs.modal', function () {
            lastFocusedElement = document.activeElement;
        });

        modalElement.on('hidden.bs.modal', function () {
            if (lastFocusedElement) {
                lastFocusedElement.focus();
                lastFocusedElement.blur();
            }
        });

    }
</script>
<script th:src="@{/js/common_list.js}" type="text/javascript"></script>
</body>
</html>